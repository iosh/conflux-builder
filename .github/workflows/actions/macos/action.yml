name: "macOS Build Action"
description: "Build Conflux for macOS platform"

inputs:
  commit_sha:
    description: "The commit hash of conflux-rust to build"
    required: true
  version_tag:
    description: "The version tag for the release"
    required: true
  arch:
    description: "CPU Architecture"
    required: true
  static_openssl:
    description: "Whether to statically link OpenSSL"
    required: true
    default: "true"
outputs:
  build_path:
    description: "Path to the build artifacts"
    value: ${{ steps.package.outputs.build_path }}

runs:
  using: "composite"
  steps:
    - name: Install Rust toolchain
      shell: bash
      working-directory: conflux-rust
      run: |
        rustup show
        rustup target add ${{ inputs.arch }}-apple-darwin
        rustup component add rustfmt rust-src

    - name: Install Dependencies
      shell: bash
      run: |
        brew install bzip2
    - name: Setup Env
      shell: bash
      run: |
        if [[ "${{ inputs.static_openssl }}" == 'true' ]]; then
          echo "Setting environment for STATIC linking."
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
        fi

    - name: Build Project
      shell: bash
      working-directory: conflux-rust
      run: |
        echo "--- Building Conflux for macOS ---"
        RUSTFLAGS="-L $(brew --prefix bzip2)/lib -l bz2" cargo build --release --target=${{ inputs.arch }}-apple-darwin

    - name: Set build path output
      id: package
      shell: bash
      run: |
        BUILD_PATH="target/${{ inputs.arch }}-apple-darwin/release"
        echo "build_path=$BUILD_PATH" >> $GITHUB_OUTPUT
